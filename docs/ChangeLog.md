# 变更日志 (ChangeLog)

本文档记录了项目的所有重要变更。

## [1.1.0] - 2025-02-20

### 新增功能

#### 多文件支持

- **批量文件导入**
  - 微信账单支持同时选择多个文件进行导入
  - 支付宝账单支持同时选择多个文件进行导入
  - 自动合并所有选择的文件数据

#### 文件格式支持扩展

- **微信账单格式支持**
  - 新增支持XLSX格式的微信账单文件
  - 保留对CSV格式的支持
  - 重构代码结构，将CSV和XLSX格式的读取分离为独立函数
  - 统一格式化处理逻辑，提取 `wechat_bill_data_format`函数

#### 数据过滤增强

- **支付宝账单过滤优化**
  - 新增自动过滤"交易关闭"状态的记录
  - 提高数据准确性，避免统计已关闭的交易

#### 命令行参数支持

- **灵活的输出模式**
  - 新增 `-s/--separate` 参数：支持收支分离导出模式
    - 默认模式：导出单文件（包含明细和统计两个工作表）
    - 分离模式：分别导出收入和支出两张表
  - 新增 `-f/--format` 参数：支持选择输出格式
    - 支持 `xlsx` 格式（默认）
    - 支持 `csv` 格式
    - CSV 格式下，明细和统计分别输出为两个文件

#### 输出功能增强

- **输出路径和文件名优化**

  - `output_result`函数新增 `target`参数，支持自定义输出文件名
  - 所有输出文件自动添加时间戳后缀（格式：`YYYYMMDD_HHMMSS`）
  - 避免文件覆盖，方便版本管理
  - 统一输出到 `./output/` 目录（替代原来的 `./OriginalBills/` 目录）
- **CSV 格式支持**

  - `output_result` 函数支持 CSV 格式导出
    - XLSX 格式：单文件包含"明细"和"统计"两个工作表
    - CSV 格式：分别输出 `{target}_明细.csv` 和 `{target}_统计.csv` 两个文件
  - CSV 文件使用 UTF-8-BOM 编码，确保 Excel 正确显示中文

#### 新增工具函数

- **账单格式化工具**

  - `refactor_wechat_bill`：单独格式化微信账单并输出
  - `refactor_alipay_bill`：单独格式化支付宝账单并输出
- **账单合并工具**

  - `combine_bills`：合并多个已知格式的Excel账单文件
  - 支持从第二行开始读取数据的标准格式
- **支出分类统计**

  - `expanse_by_type`：按自定义类别统计每月支出
  - 支持按年份、月份和自定义类别进行分组统计
  - 自动计算每个类别和总计
- **收支分离导出功能**

  - `export_income_expense_separately`：将收入和支出分开导出（原 `export_for_firefly` 函数重构）
  - 支持 XLSX 和 CSV 两种格式
  - 自动分离收入和支出数据
  - 分别输出到 `./output/支出_{时间戳}.{格式}`和 `./output/收入_{时间戳}.{格式}`
  - 自动过滤金额为0的记录
  - 在备注前自动添加"支出 "或"收入 "前缀
  - 改进备注处理逻辑，使用更安全的数据类型转换
  - 文件名改为带时间戳的格式
  - 自动创建output目录（如果不存在）

### 代码改进

- **代码重构**

  - 将微信账单格式化逻辑提取为独立函数 `wechat_bill_data_format`
  - 分离CSV和XLSX格式的读取逻辑，提高代码可维护性
  - 添加 `os`模块导入，支持目录创建功能
- **新增工具函数**

  - `get_output_time_suffix()`：生成标准化的时间戳字符串（格式：`YYYYMMDD_HHMMSS`）
  - `parse_args()`：解析命令行参数，提供友好的帮助信息
- **输出路径统一**

  - 所有输出文件统一保存到 `./output/` 目录
  - 自动创建输出目录（如果不存在）
- **主程序逻辑优化**

  - 根据命令行参数动态选择导出方式
  - 默认导出为单文件模式（明细+统计）
  - 支持通过 `-s` 参数切换到收支分离模式

### 技术改进

- **依赖库**

  - 新增对Excel文件读取的支持（pandas的read_excel功能）
  - 新增 `argparse` 模块：用于命令行参数解析
  - 新增 `datetime` 模块：用于生成时间戳
- **编码处理**

  - CSV 文件统一使用 `utf-8-sig` 编码，确保 Excel 正确识别中文

### 修复的问题

- 无

### 已知限制

- 支付宝账单仍仅支持CSV格式

---

## [1.0.0] - 2024-01-04

### 功能特性

#### 核心功能

- **账单数据读取**
  - 支持读取微信支付账单（CSV格式）

    - 自动识别账单格式（从第17行开始读取数据）
    - 统一列名格式（将"当前状态"改为"交易状态"，"交易类型"改为"类型"，"金额(元)"改为"金额"）
    - 自动处理交易时间格式转换
    - 自动去除金额中的货币符号（¥）
    - 过滤不计收支项（删除"收/支"为"/"的记录）
    - 处理空备注（将"/"替换为空字符串）
    - 添加来源标识（标记为"微信"）
  - 支持读取支付宝账单（CSV格式）

    - 自动识别账单格式（从第25行开始读取数据，使用GBK编码）
    - 统一列名格式以匹配微信格式
      - "交易分类" → "类型"
      - "商品说明" → "商品"
      - "收/付款方式" → "支付方式"
      - "交易订单号" → "交易单号"
      - "商家订单号" → "商户单号"
    - 合并交易对方和对方账号信息
    - 自动处理交易时间格式转换
    - 过滤不计收支项（删除"收/支"为"不计收支"的记录）
    - 添加来源标识（标记为"支付宝"）

#### 数据处理功能

- **数据合并**

  - 支持同时导入微信和支付宝账单
  - 自动合并两个平台的账单数据
  - 统一数据格式为微信账单格式
  - 验证数据有效性（至少需要选择一个账单文件）
- **时间维度扩展**

  - 自动从交易时间中提取年份
  - 自动从交易时间中提取月份
  - 方便后续按时间维度进行统计分析

#### 统计分析功能

- **月度收支统计**
  - 按年份、月份、来源（微信/支付宝）、收支类型进行分组统计
  - 计算每月收入总额
  - 计算每月支出总额
  - 计算每月净收入（收入 - 支出）

#### 输出功能

- **Excel文件导出**
  - 生成包含两个工作表的Excel文件
    - "明细"工作表：包含所有合并后的账单明细数据
    - "统计"工作表：包含按月统计的收支汇总数据
  - 输出文件路径：`../合并结果.xlsx`
  - 使用openpyxl引擎进行Excel文件写入

#### 用户交互功能

- **图形化文件选择**

  - 使用tkinter文件对话框选择账单文件
  - 支持选择微信账单文件
  - 支持选择支付宝账单文件
  - 支持取消选择（允许只选择一个平台的账单）
- **控制台输出**

  - 彩色控制台输出（使用ANSI颜色代码）
    - 微信相关提示使用绿色
    - 支付宝相关提示使用蓝色
    - 文件路径提示使用黄色
  - 显示成功读取的账单条数
  - 显示数据写入完成提示
- **程序退出控制**

  - 当未选择任何账单时，显示提示信息并退出
  - 数据写入完成后，提示用户按任意键退出程序

### 技术实现

- **依赖库**

  - pandas：用于数据处理和分析
  - tkinter：用于文件选择对话框
  - keyboard：用于键盘输入监听
  - openpyxl：用于Excel文件写入
- **数据格式处理**

  - 统一时间格式为datetime64[ns]
  - 统一金额格式为float64
  - 统一列名格式以便合并
  - 自动处理不同平台的编码差异（微信使用UTF-8，支付宝使用GBK）

### 已知限制

- 仅支持CSV格式的账单文件
- 输出文件路径固定为相对路径 `../合并结果.xlsx`
- 需要手动选择账单文件，不支持批量处理
